<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>스터디룸</title>
  <link rel="stylesheet" th:href="@{/common-styles.css}">
  <link rel="stylesheet" th:href="@{/studyroom-styles.css}">
</head>
<body>
<!-- 공통 헤더 include -->
<div th:replace="~{fragments/header :: header}"></div>

<div class="container">
  <div class="header-bar">
    <div>
      <strong th:text="${studygroup?.groupName ?: '스터디 없음'}">프로그래밍 기초</strong>
    </div>
    <div>
      <span th:text="|참여자 ${studygroup?.currentMembers ?: 0}명|">참여자 0명</span>
    </div>
  </div>

  <div class="stream-box">
    <video id="localVideo" autoplay playsinline style="width: 100%; height: 100%; display: none;"></video>
    <button class="stream-button" onclick="startStream()"
            style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
      스트림 시작
    </button>
  </div>

  <div class="main-content">
    <div class="left-box box">
      <h3>질문 게시판</h3>
      <div th:if="${board != null && board.postList != null}">
        <p th:each="post : ${board.postList}" th:text="${post.title}">
          게시글 제목
        </p>
        <p th:if="${#lists.isEmpty(board.postList)}">등록된 게시글이 없습니다.</p>
      </div>
      <div th:if="${board == null || board.postList == null}">
        <p>게시판이 아직 생성되지 않았습니다.</p>
      </div>
      <div class="button-bar">
        <button class="small-button"
                th:onclick="'location.href=\'/study/room/' + ${studygroup?.id} + '/post/new\''">
          질문하기
        </button>
      </div>
    </div>

    <div class="right-boxes">
      <div class="box">
        <h3>학습자료</h3>
        <div>
          <!-- 학습자료가 없을 때의 메시지 -->
          <p>등록된 학습자료가 없습니다.</p>
        </div>
        <div class="button-bar">
          <button class="small-button">자료 업로드</button>
        </div>
      </div>

      <div class="box">
        <h3>학습 일정</h3>
        <div>
          <!-- 일정이 없을 때의 메시지 -->
          <p>등록된 일정이 없습니다.</p>
        </div>
        <div class="button-bar">
          <button class="small-button">일정 추가</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 공통 푸터 include -->
<div th:replace="~{fragments/footer :: footer}"></div>

<script th:inline="javascript">
  /*<![CDATA[*/
  const studygroupId = [[${studygroupId}]];
  /*]]>*/

  async function startStream() {
      try {
          const stream = await navigator.mediaDevices.getUserMedia({
              video: true,
              audio: false
          });

          const videoElement = document.getElementById('localVideo');
          videoElement.srcObject = stream;
          videoElement.style.display = 'block';

          const button = document.querySelector('.stream-button');
          button.textContent = '스트림 종료';
          button.onclick = stopStream;

      } catch (error) {
          console.error('스트림 시작 실패:', error);
          alert('카메라 접근에 실패했습니다.');
      }
  }

  function stopStream() {
      const videoElement = document.getElementById('localVideo');
      const stream = videoElement.srcObject;
      const tracks = stream.getTracks();

      tracks.forEach(track => track.stop());
      videoElement.srcObject = null;
      videoElement.style.display = 'none';

      const button = document.querySelector('.stream-button');
      button.textContent = '스트림 시작';
      button.onclick = startStream;
  }
</script>
</body>
</html>